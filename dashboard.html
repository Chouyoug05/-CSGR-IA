<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Tableau de bord - CSGR-IA</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/csgr-ia-logo.png">
  <link rel="apple-touch-icon" href="images/csgr-ia-logo.png">
  <link rel="stylesheet" href="vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="css/style.min.css">
  <link rel="stylesheet" href="css/csgr-custom.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100vh; overflow: hidden; }
    
    .layout { display: flex; height: 100vh; width: 100%; }
    
    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #343a40;
      color: white;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      overflow-y: auto;
      z-index: 1000;
    }
    .sidebar-header {
      padding: 20px;
      background: #2c3136;
      border-bottom: 1px solid #495057;
    }
    .sidebar-header h2 { font-size: 18px; font-weight: bold; }
    .sidebar-header small { color: #adb5bd; }
    .sidebar-nav { padding: 10px 0; }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #adb5bd;
      text-decoration: none;
      border-left: 3px solid transparent;
      transition: all 0.3s;
    }
    .sidebar-nav a:hover { background: #495057; color: #fff; border-left-color: #007bff; }
    .sidebar-nav a.active { background: #007bff; color: #fff; border-left-color: #0056b3; }
    .sidebar-nav a i { margin-right: 10px; font-size: 20px; width: 30px; text-align: center; }
    
    /* Main */
    .main {
      margin-left: 250px;
      width: calc(100% - 250px);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Header */
    .header {
      background: white;
      padding: 15px 25px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header .title-section { display: flex; align-items: center; gap: 15px; }
    .header .title-section img { max-height: 40px; }
    .header .title { font-size: 22px; font-weight: bold; color: #1e293b; margin: 0; }
    
    /* Content */
    .content {
      padding: 25px;
      overflow-y: auto;
      height: 100%;
      background: #f4f6f9;
    }
    
    .section-content { display: none; }
    .section-content.active { display: block; }
    
    /* Cards */
    .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card {
      background: linear-gradient(135deg, #0061f2 0%, #00a8e8 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.red { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-card h3 { font-size: 32px; margin: 0; }
    .stat-card p { margin: 5px 0 0 0; opacity: 0.9; }
    
    /* Overlay mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .sidebar-overlay.show { display: block; }
    
    /* Bouton fermer sidebar */
    .sidebar-close {
      display: none;
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      z-index: 10;
    }
    
    /* Bouton toggle sidebar - par défaut caché sur desktop */
    .sidebar-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      padding: 5px 10px;
      color: #333;
      z-index: 100;
    }
    
    /* Responsive Mobile */
    @media (max-width: 991px) {
      .sidebar {
        left: -280px;
        transition: left 0.3s ease;
        width: 280px;
      }
      .sidebar.show {
        left: 0;
      }
      .sidebar-close {
        display: block;
      }
      .main {
        margin-left: 0;
        width: 100%;
      }
      .sidebar-toggle {
        display: flex !important;
        align-items: center;
        justify-content: center;
      }
      .header .title {
        font-size: 14px;
      }
      .header {
        padding: 8px 10px;
      }
      .header-actions .btn {
        padding: 4px 8px;
        font-size: 12px;
      }
      .header-actions .btn span,
      .header-actions .btn .mr-1 + span {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Overlay pour fermer sidebar mobile -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" id="sidebar-close">
      <i class="mdi mdi-close"></i>
    </button>
    <div class="sidebar-header">
      <h2>CSGR-IA</h2>
      <small>Tableau de bord</small>
    </div>
    <nav class="sidebar-nav">
      <a href="#" data-section="inscriptions" class="active">
        <i class="mdi mdi-account-check"></i> Inscriptions
      </a>
      <a href="#" data-section="programmes">
        <i class="mdi mdi-book-open-variant"></i> Programmes
      </a>
      <a href="#" data-section="actualites">
        <i class="mdi mdi-newspaper"></i> Actualités
      </a>
      <a href="#" data-section="statistiques">
        <i class="mdi mdi-chart-line"></i> Statistiques
      </a>
      <a href="#" data-section="cta">
        <i class="mdi mdi-bullhorn"></i> Section CTA
      </a>
      <a href="#" data-section="popup">
        <i class="mdi mdi-popup"></i> Popup Promotion
      </a>
      <a href="#" data-section="temoignages">
        <i class="mdi mdi-comment-account"></i> Témoignages
      </a>
      <a href="#" data-section="contact">
        <i class="mdi mdi-contact-mail"></i> Contact
      </a>
      <a href="#" data-section="partenaires">
        <i class="mdi mdi-handshake"></i> Partenaires
      </a>
    </nav>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="header">
      <div class="title-section">
        <button class="sidebar-toggle" id="sidebar-toggle" type="button" aria-label="Menu">
          <i class="mdi mdi-menu" style="pointer-events: none;"></i>
        </button>
        <img src="images/csgr-ia-logo.png" alt="CSGR-IA">
        <h1 class="title">Tableau de bord</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline-secondary btn-sm" onclick="refreshAllData()" title="Rafraîchir les données">
          <i class="mdi mdi-refresh"></i>
        </button>
        <a href="index.html" class="btn btn-outline-primary btn-sm">
          <i class="mdi mdi-arrow-left mr-1"></i> Site
        </a>
        <button class="btn btn-danger btn-sm" id="logout-btn">
          <i class="mdi mdi-logout mr-1"></i> Déconnexion
        </button>
      </div>
    </div>

    <div class="content">
      <!-- Section Inscriptions -->
      <div id="section-inscriptions" class="section-content active">
        <h2 class="mb-4">Inscriptions</h2>
        <div class="stat-cards">
          <div class="stat-card"><h3 id="stats-total">0</h3><p>Total</p></div>
          <div class="stat-card green"><h3 id="stats-validees">0</h3><p>Validées</p></div>
          <div class="stat-card orange"><h3 id="stats-attente">0</h3><p>En attente</p></div>
          <div class="stat-card red"><h3 id="stats-echouees">0</h3><p>Échouées</p></div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-3 mb-2">
                <select class="form-control" id="filter-programme"><option value="">Tous les programmes</option></select>
              </div>
              <div class="col-md-3 mb-2">
                <select class="form-control" id="filter-statut">
                  <option value="">Tous les statuts</option>
                  <option value="en_attente">En attente</option>
                  <option value="valide">Validé</option>
                  <option value="echoue">Échoué</option>
                </select>
              </div>
              <div class="col-md-3 mb-2">
                <button class="btn btn-primary btn-block" onclick="exportCSV()"><i class="mdi mdi-download mr-1"></i>Exporter</button>
              </div>
            </div>
            <div id="inscriptions-list"></div>
          </div>
        </div>
      </div>

      <!-- Section Programmes -->
      <div id="section-programmes" class="section-content">
        <div class="mb-4">
          <h2 class="mb-3">Programmes</h2>
          <button class="btn btn-success" onclick="showProgrammeModal()"><i class="mdi mdi-plus mr-2"></i>Nouveau</button>
        </div>
        <div id="programmes-list"></div>
      </div>

      <!-- Section Actualités -->
      <div id="section-actualites" class="section-content">
        <div class="mb-4">
          <h2 class="mb-3">Actualités</h2>
          <button class="btn btn-success" onclick="showActualiteModal()"><i class="mdi mdi-plus mr-2"></i>Nouvelle</button>
        </div>
        <div id="actualites-list"></div>
      </div>

      <!-- Section Statistiques -->
      <div id="section-statistiques" class="section-content">
        <div class="mb-4">
          <h2 class="mb-3">Statistiques</h2>
          <button class="btn btn-success" onclick="showStatistiqueModal()"><i class="mdi mdi-plus mr-2"></i>Nouvelle</button>
        </div>
        <div id="statistiques-list"></div>
      </div>

      <!-- Section CTA -->
      <div id="section-cta" class="section-content">
        <h2 class="mb-4">Configuration CTA</h2>
        <div class="card">
          <div class="card-body">
            <form id="cta-form">
              <div class="form-group"><label>Titre</label><input type="text" class="form-control" id="cta-titre"></div>
              <div class="form-group"><label>Description</label><input type="text" class="form-control" id="cta-description"></div>
              <div class="form-group"><label>Texte bouton</label><input type="text" class="form-control" id="cta-texte-bouton"></div>
              <div class="form-group"><label>Lien bouton</label><input type="text" class="form-control" id="cta-lien-bouton"></div>
              <div class="form-check mb-3"><input type="checkbox" class="form-check-input" id="cta-actif"><label class="form-check-label">Actif</label></div>
              <button type="submit" class="btn btn-primary">Enregistrer</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Section Popup -->
      <div id="section-popup" class="section-content">
        <h2 class="mb-4">Popup Promotion</h2>
        <div class="alert alert-info">
          <i class="mdi mdi-information mr-2"></i>
          <strong>Info:</strong> La popup de promotion s'affiche sur la page d'accueil pour promouvoir un programme.
        </div>
        <div class="card">
          <div class="card-body">
            <form id="popup-form">
              <div class="form-group">
                <label><i class="mdi mdi-book-open-variant mr-1"></i>Programme à promouvoir *</label>
                <select class="form-control" id="popup-programme"><option value="">-- Sélectionner un programme --</option></select>
                <small class="form-text text-muted">Choisissez le programme à afficher dans la popup</small>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label><i class="mdi mdi-timer mr-1"></i>Délai avant affichage</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="popup-delai" value="2000" min="0">
                      <div class="input-group-append"><span class="input-group-text">ms</span></div>
                    </div>
                    <small class="form-text text-muted">2000 = 2 secondes</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label><i class="mdi mdi-clock-outline mr-1"></i>Cooldown</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="popup-cooldown" value="1" min="0">
                      <div class="input-group-append"><span class="input-group-text">jour(s)</span></div>
                    </div>
                    <small class="form-text text-muted">Délai avant réaffichage au même visiteur</small>
                  </div>
                </div>
              </div>
              <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="popup-actif">
                <label class="form-check-label"><strong>Activer la popup</strong></label>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary"><i class="mdi mdi-content-save mr-1"></i>Enregistrer</button>
                <a href="index.html" target="_blank" class="btn btn-success" id="btn-test-popup"><i class="mdi mdi-eye mr-1"></i>Tester sur le site</a>
                <button type="button" class="btn btn-outline-secondary" onclick="resetPopupCooldown()"><i class="mdi mdi-refresh mr-1"></i>Réinitialiser cooldown</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Section Témoignages -->
      <div id="section-temoignages" class="section-content">
        <div class="mb-4">
          <h2 class="mb-3">Témoignages</h2>
          <button class="btn btn-success" onclick="showTemoignageModal()"><i class="mdi mdi-plus mr-2"></i>Nouveau</button>
        </div>
        <div id="temoignages-list"></div>
      </div>

      <!-- Section Contact -->
      <div id="section-contact" class="section-content">
        <h2 class="mb-4">Informations Contact</h2>
        <div class="card">
          <div class="card-body">
            <form id="contact-form">
              <div class="form-group"><label>Email</label><input type="email" class="form-control" id="contact-email"></div>
              <div class="form-group"><label>Téléphone</label><input type="tel" class="form-control" id="contact-phone"></div>
              <div class="form-group"><label>Adresse</label><textarea class="form-control" id="contact-address" rows="3"></textarea></div>
              <button type="submit" class="btn btn-primary">Enregistrer</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Section Partenaires -->
      <div id="section-partenaires" class="section-content">
        <div class="mb-4">
          <h2 class="mb-3">Partenaires</h2>
          <button class="btn btn-success" onclick="showPartenaireModal()"><i class="mdi mdi-plus mr-2"></i>Nouveau partenaire</button>
        </div>
        <div id="partenaires-list"></div>
      </div>
    </div>
  </div>

  <!-- Modal Partenaire -->
  <div class="modal fade" id="partenaireModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Partenaire</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="partenaire-form">
            <input type="hidden" id="partenaire-id">
            <div class="form-group">
              <label>Nom du partenaire *</label>
              <input type="text" class="form-control" id="partenaire-nom" required>
            </div>
            <div class="form-group">
              <label>Logo (URL de l'image) *</label>
              <input type="text" class="form-control" id="partenaire-logo" placeholder="https://exemple.com/logo.png" required>
              <small class="form-text text-muted">Utilisez une URL d'image (PNG, JPG, SVG)</small>
            </div>
            <div class="form-group">
              <label>Site web</label>
              <input type="url" class="form-control" id="partenaire-site" placeholder="https://www.exemple.com">
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="partenaire-description" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Ordre d'affichage</label>
              <input type="number" class="form-control" id="partenaire-ordre" value="0">
            </div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="programmeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Programme</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <form id="programme-form">
            <input type="hidden" id="programme-id">
            <div class="form-group"><label>Nom *</label><input type="text" class="form-control" id="programme-nom" required></div>
            <div class="form-group"><label>Description courte</label><textarea class="form-control" id="programme-desc-courte" rows="2"></textarea></div>
            <div class="form-group"><label>Description longue</label><textarea class="form-control" id="programme-desc-longue" rows="4"></textarea></div>
            <div class="row">
              <div class="col-md-6"><div class="form-group"><label>Date début</label><input type="date" class="form-control" id="programme-date"></div></div>
              <div class="col-md-6"><div class="form-group"><label>Durée</label><input type="text" class="form-control" id="programme-duree"></div></div>
            </div>
            <div class="row">
              <div class="col-md-6"><div class="form-group"><label>Lieu</label><input type="text" class="form-control" id="programme-lieu"></div></div>
              <div class="col-md-6"><div class="form-group"><label>Prix (XAF)</label><input type="number" class="form-control" id="programme-prix" value="0"></div></div>
            </div>
            <div class="row">
              <div class="col-md-6"><div class="form-group"><label>Catégorie</label><select class="form-control" id="programme-categorie"><option value="debutant">Débutant</option><option value="intermediaire">Intermédiaire</option><option value="avance">Avancé</option></select></div></div>
              <div class="col-md-6"><div class="form-group"><label>Icône</label><input type="text" class="form-control" id="programme-icone" placeholder="mdi-book"></div></div>
            </div>
            <div class="form-group"><label>Couleur</label><input type="color" class="form-control" id="programme-couleur" value="#007bff"></div>
            <div class="form-group"><label>Image (URL)</label><input type="text" class="form-control" id="programme-image"></div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="actualiteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Actualité</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <form id="actualite-form">
            <input type="hidden" id="actualite-id">
            <div class="form-group"><label>Titre *</label><input type="text" class="form-control" id="actualite-titre" required></div>
            <div class="form-group"><label>Description</label><textarea class="form-control" id="actualite-description" rows="2"></textarea></div>
            <div class="form-group"><label>Contenu</label><textarea class="form-control" id="actualite-contenu" rows="6"></textarea></div>
            <div class="row">
              <div class="col-md-6"><div class="form-group"><label>Date</label><input type="date" class="form-control" id="actualite-date"></div></div>
              <div class="col-md-6"><div class="form-group"><label>Lieu</label><input type="text" class="form-control" id="actualite-lieu"></div></div>
            </div>
            <div class="form-group"><label>Image (URL)</label><input type="text" class="form-control" id="actualite-image"></div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="statistiqueModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Statistique</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <form id="statistique-form">
            <input type="hidden" id="statistique-id">
            <div class="form-group"><label>Label *</label><input type="text" class="form-control" id="statistique-label" required></div>
            <div class="form-group"><label>Valeur *</label><input type="text" class="form-control" id="statistique-valeur" required></div>
            <div class="form-group"><label>Icône</label><input type="text" class="form-control" id="statistique-icone" placeholder="mdi-account-group"></div>
            <div class="form-group"><label>Couleur</label><input type="color" class="form-control" id="statistique-couleur" value="#007bff"></div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="temoignageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Témoignage</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <form id="temoignage-form">
            <input type="hidden" id="temoignage-id">
            <div class="form-group"><label>Nom *</label><input type="text" class="form-control" id="temoignage-nom" required></div>
            <div class="form-group"><label>Fonction</label><input type="text" class="form-control" id="temoignage-fonction"></div>
            <div class="form-group"><label>Texte *</label><textarea class="form-control" id="temoignage-texte" rows="5" required></textarea></div>
            <div class="form-group"><label>Image (URL)</label><input type="text" class="form-control" id="temoignage-image"></div>
            <div class="form-group"><label>Ordre</label><input type="number" class="form-control" id="temoignage-ordre" value="0"></div>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery et Bootstrap en premier (nécessaires immédiatement) -->
  <script src="vendors/jquery/jquery.min.js"></script>
  <script src="vendors/bootstrap/bootstrap.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <!-- Scripts CSGR -->
  <script src="js/firebase-config.js"></script>
  <script src="js/csgr-firebase.js"></script>
  <script src="js/csgr-data.js"></script>
  <script src="js/csgr-admin.js"></script>
  
  <!-- html2canvas chargé en différé (pas nécessaire au démarrage) -->
  <script>
    // Charger html2canvas seulement quand nécessaire
    window.loadHtml2Canvas = function() {
      if (!window.html2canvas) {
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(script);
      }
    };
  </script>
  <script>
    $(document).ready(function() {
      // Vérifier si connecté, sinon rediriger vers login
      const savedUser = sessionStorage.getItem('member_user');
      if (!savedUser) {
        window.location.href = 'membre.html';
        return;
      }

      // Déconnexion
      $('#logout-btn').on('click', function() {
        sessionStorage.removeItem('member_user');
        window.location.href = 'membre.html';
      });

      // Fonction pour fermer la sidebar
      function closeSidebar() {
        $('#sidebar').removeClass('show');
        $('#sidebar-overlay').removeClass('show');
      }
      
      // Fonction pour ouvrir la sidebar
      function openSidebar() {
        $('#sidebar').addClass('show');
        $('#sidebar-overlay').addClass('show');
      }
      
      // Toggle sidebar mobile
      $('#sidebar-toggle').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Toggle sidebar clicked');
        if ($('#sidebar').hasClass('show')) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });
      
      // Aussi attacher sur l'icône à l'intérieur du bouton
      $('#sidebar-toggle i').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('#sidebar-toggle').trigger('click');
      });
      
      // Fermer sidebar via bouton X
      $('#sidebar-close').on('click', function(e) {
        e.preventDefault();
        closeSidebar();
      });
      
      // Fermer sidebar via overlay
      $('#sidebar-overlay').on('click', function() {
        closeSidebar();
      });

      // Navigation sidebar
      $('.sidebar-nav a').on('click', function(e) {
        e.preventDefault();
        const section = $(this).data('section');
        $('.sidebar-nav a').removeClass('active');
        $(this).addClass('active');
        $('.section-content').removeClass('active');
        $('#section-' + section).addClass('active');
        // Fermer sidebar sur mobile
        closeSidebar();
      });
    });
  </script>
</body>
</html>

